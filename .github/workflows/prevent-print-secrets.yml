name: Prevent Printed Secrets

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  block-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan repo for token-like patterns
        run: |
          set -o pipefail
          echo "Searching for Wix IST tokens and Airtable pat tokens..."
          if git grep -n --untracked -I -e '^IST\.eyJ' -e '\bpat[A-Za-z0-9]\{20,\}' -- '*.js' '*.ts' '*.tsx' '*.jsx' '*.json' '*.md' '*.yml' '*.yaml' 2>/dev/null | grep -v 'prevent-print-secrets.yml' | grep -v 'SECURITY_CHECKLIST'; then
            echo "Found possible secret tokens in repository. Failing build." >&2
            exit 1
          fi
          echo "No secret tokens found in repo files."

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for common secret patterns..."
          if git grep -n -i -E '(api[_-]?key|secret|token|password)["\s]*[:=]["\s]*[A-Za-z0-9_-]{20,}' -- '*.js' '*.ts' '*.jsx' '*.tsx' '*.json' '*.env*' 2>/dev/null | grep -v '.env.example' | grep -v 'node_modules'; then
            echo "Found hardcoded secrets. Please use environment variables." >&2
            exit 1
          fi
          echo "No hardcoded secrets found."

